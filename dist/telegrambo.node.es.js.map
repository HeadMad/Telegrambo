{"version":3,"file":"telegrambo.node.es.js","sources":["../utils/prepareRequestPayload.js","../utils/createNodeRequestSender.js","../src/createEventContextPayload.js","../src/EventContext.js","../utils/createHandlerStorage.js","../src/errors.js","../src/BotContext.js","../src/createNodeBot.js"],"sourcesContent":["const STRING_PROPS = new Set(['chat_id', 'from_chat_id', 'text']);\r\n\r\n/**\r\n * Prepares the request payload by creating a deep copy of the input object and then converting it to a JSON string.\r\n *\r\n * @param {object} requestPayload - The input request payload object.\r\n * @return {string} - The JSON string representation of the modified request payload.\r\n */\r\nfunction prepareRequestPayload(requestPayloadEntries) {\r\n  const result = {};\r\n  for (let [key, value] of requestPayloadEntries)\r\n    if (STRING_PROPS.has(key))\r\n      result[key] = String(value);\r\n    else if (typeof value === 'object')\r\n      result[key] = JSON.stringify(value);\r\n    else\r\n      result[key] = value;\r\n\r\n  return result;\r\n}\r\n\r\nexport default prepareRequestPayload;","import https from \"https\";\nimport { URL } from \"url\";\nimport { promises as fs } from \"fs\";\nimport prepareRequestPayload from \"./prepareRequestPayload.js\";\n\nexport default createNodeRequestSender;\n\nfunction createNodeRequestSender(token, { timeout = 30000, apiUrl = 'https://api.telegram.org' } = {}) {\n  if (!token || typeof token !== 'string') {\n    throw new Error('Token must be a non-empty string');\n  }\n\n  return async function requestSender(method, payload = {}) {\n    if (!method || typeof method !== 'string') {\n      throw new Error('Method must be a non-empty string');\n    }\n\n    const url = `${apiUrl}/bot${token}/${method}`;\n    const payloadEntries = Object.entries(payload);\n\n    const hasFiles = payloadEntries.some(([key, value]) => {\n      if (isFile(value)) return true;\n      if (key === 'media' && Array.isArray(value)) {\n        return value.some(item => isFile(item?.media));\n      }\n      return false;\n    });\n\n    const request = hasFiles\n      ? await buildMultipart(payloadEntries)\n      : buildJSON(prepareRequestPayload(payloadEntries));\n\n    return sendRequest(url, request, timeout);\n  };\n}\n\nfunction isFile(value) {\n  if (!value || typeof value !== 'object') return false;\n  return value instanceof Buffer ||\n         (typeof value.pipe === 'function' && value.path) || // Ensure it's a file stream\n         value.source instanceof Buffer ||\n         (typeof value.source?.pipe === 'function' && value.source.path);\n}\n\nfunction buildJSON(payload) {\n  const body = JSON.stringify(payload);\n  const buffer = Buffer.from(body);\n  return {\n    body: buffer,\n    headers: {\n      'Content-Type': 'application/json',\n      'Content-Length': buffer.length,\n    },\n  };\n}\n\nasync function getSourceInfo(source) {\n  if (source instanceof Buffer) {\n    return { size: source.length, stream: source };\n  }\n  if (typeof source.pipe === 'function' && source.path) {\n    const stat = await fs.stat(source.path);\n    return { size: stat.size, stream: source };\n  }\n  throw new Error('Invalid file source provided.');\n}\n\nasync function buildMultipart(payloadEntries) {\n  const boundary = `----TB${Date.now()}${Math.random().toString(36).slice(2)}`;\n  const eol = '\\r\\n';\n  const finalBoundary = `--${boundary}--${eol}`;\n  \n  const parts = [];\n  let totalLength = 0;\n\n  const filesToProcess = [];\n  const processedPayload = {};\n\n  // First, process payload to handle 'attach://' logic\n  let fileIndex = 0;\n  for (const [key, value] of payloadEntries) {\n    if (isFile(value)) {\n      const attachName = `file${fileIndex++}`;\n      filesToProcess.push({ fieldName: attachName, file: value });\n      processedPayload[key] = `attach://${attachName}`;\n    } else if (key === 'media' && Array.isArray(value)) {\n      processedPayload[key] = value.map(item => {\n        if (item && typeof item === 'object' && isFile(item.media)) {\n          const attachName = `file${fileIndex++}`;\n          filesToProcess.push({ fieldName: attachName, file: item.media });\n          return { ...item, media: `attach://${attachName}` };\n        }\n        return item;\n      });\n    } else {\n      processedPayload[key] = value;\n    }\n  }\n  \n  // Create parts for regular fields\n  for (const [key, value] of Object.entries(processedPayload)) {\n    const isObject = typeof value === 'object' && value !== null;\n    const str = isObject ? JSON.stringify(value) : String(value);\n\n    let part = `--${boundary}${eol}`;\n    part += `Content-Disposition: form-data; name=\"${key}\"${eol}`;\n    if (isObject) {\n      part += `Content-Type: application/json${eol}`;\n    }\n    part += `${eol}${str}${eol}`;\n\n    const buffer = Buffer.from(part);\n    parts.push(buffer);\n    totalLength += buffer.length;\n  }\n\n  // Create parts for files\n  for (const { fieldName, file } of filesToProcess) {\n    const { source, filename = 'file', contentType = 'application/octet-stream' } = file;\n    const { size, stream } = await getSourceInfo(source || file);\n\n    const headPart = [\n        `--${boundary}${eol}`,\n        `Content-Disposition: form-data; name=\"${fieldName}\"; filename=\"${filename}\"${eol}`,\n        `Content-Type: ${contentType}${eol}${eol}`,\n    ].join('');\n    \n    const headBuffer = Buffer.from(headPart);\n    parts.push(headBuffer);\n    totalLength += headBuffer.length;\n    \n    parts.push(stream);\n    totalLength += size;\n\n    const eolBuffer = Buffer.from(eol);\n    parts.push(eolBuffer);\n    totalLength += eolBuffer.length;\n  }\n\n  const finalBoundaryBuffer = Buffer.from(finalBoundary);\n  parts.push(finalBoundaryBuffer);\n  totalLength += finalBoundaryBuffer.length;\n\n  return {\n    body: parts,\n    headers: {\n      'Content-Type': `multipart/form-data; boundary=${boundary}`,\n      'Content-Length': totalLength,\n    },\n  };\n}\n\nfunction sendRequest(url, { body, headers }, timeout) {\n  return new Promise((resolve, reject) => {\n    const { hostname, port, pathname } = new URL(url);\n\n    const req = https.request(\n      {\n        hostname,\n        port: port || 443,\n        path: pathname,\n        method: 'POST',\n        headers,\n        timeout,\n      },\n      (res) => {\n        const chunks = [];\n        res.on('data', (chunk) => chunks.push(chunk));\n        res.on('end', () => {\n          const resBody = Buffer.concat(chunks).toString();\n          try {\n            const data = JSON.parse(resBody);\n            resolve(data);\n          } catch (e) {\n            reject(new Error(`Failed to parse response: ${resBody}`));\n          }\n        });\n      }\n    );\n\n    req.on('error', reject);\n    req.on('timeout', () => {\n      req.destroy();\n      reject(new Error('Request timeout'));\n    });\n\n    if (Array.isArray(body)) {\n      // Streaming multipart body\n      (async () => {\n        try {\n          for (const part of body) {\n            if (part instanceof Buffer) {\n              req.write(part);\n            } else { // Is a stream\n              await new Promise((pResolve, pReject) => {\n                part.on('error', pReject);\n                part.pipe(req, { end: false });\n                part.on('end', pResolve);\n              });\n            }\n          }\n          req.end();\n        } catch (err) {\n          req.destroy(err);\n        }\n      })();\n    } else {\n      // Simple JSON body\n      req.write(body);\n      req.end();\n    }\n  });\n}","const ContextDataEvents = new Map();\r\n\r\n// Incomming messages\r\nContextDataEvents.set('message', event => ({\r\n    chat_id: event.chat.id,\r\n    from_chat_id: event.chat.id,\r\n    message_id: event.message_id,\r\n    message_thread_id: event?.message_thread_id,\r\n    direct_messages_topic_id: event?.direct_messages_topic?.topic_id\r\n}));\r\n\r\n// Обработчик для бизнесс аккаунта\r\nconst businessHandler = event => ({\r\n  business_connection_id: event.business_connection_id,\r\n  chat_id: event.chat.id,\r\n  message_id: event.message_id\r\n});\r\n\r\nContextDataEvents.set('business_message', businessHandler);\r\nContextDataEvents.set('edited_business_message', businessHandler);\r\nContextDataEvents.set('deleted_business_messages', businessHandler);\r\n\r\nContextDataEvents.set('business_connection', event => ({\r\n  chat_id: event.user_chat_id,\r\n  // business_connection_id: event.id\r\n}));\r\n\r\n\r\n// request of pushed inline button\r\nContextDataEvents.set('callback_query', event => ({\r\n  chat_id: event.message.chat.id,\r\n  callback_query_id: event.id,\r\n  message_id: event.message.message_id\r\n}));\r\n\r\n\r\nContextDataEvents.set('inline_query', event => ({\r\n  inline_query_id: event.id\r\n}));\r\n\r\n// Post to channel\r\nContextDataEvents.set('channel_post', event => ({\r\n  chat_id: event.chat.id,\r\n  message_id: event.message_id\r\n}));\r\n\r\n// Voited in poll\r\nContextDataEvents.set('poll_answer', event => ({\r\n  chat_id: 'user' in event ? event.user.id : event.voter_chat.id\r\n}));\r\n\r\n// Запрос на  вступление в чат\r\nContextDataEvents.set('chat_join_request', event => ({\r\n  chat_id: event.from.id\r\n}));\r\n\r\n// Чат получил boost\r\nContextDataEvents.set('chat_boost', event => ({\r\n  chat_id: event.boost.source.user.id\r\n}));\r\n\r\n// Пользователь удалил boost\r\nContextDataEvents.set('removed_chat_boost', event => ({\r\n  chat_id: event.source.user.id\r\n}));\r\n\r\n\r\nexport default createEventContextPayload;\r\n\r\n\r\n/**\r\n * Generates the payload for a given event context.\r\n *\r\n * @param {string} eventName - The name of the event.\r\n * @param {any} eventData - The data associated with the event.\r\n * @return {object} The payload for the event context.\r\n */\r\nfunction createEventContextPayload(eventName, eventData) {\r\n  if (ContextDataEvents.has(eventName))\r\n    return ContextDataEvents.get(eventName)(eventData);\r\n\r\n    return {};\r\n}\r\n  \r\n","import createEventContextPayload from './createEventContextPayload.js';\r\n\r\nexport default EventContext;\r\n\r\n\r\n/**\r\n * Creates a new EventContext object.\r\n *\r\n * @param {function} requestSender - The function used to send requests.\r\n * @param {string} eventName - The name of the event.\r\n * @param {object} eventPayload - An object containing event data.\r\n * @return {object} The new EventContext object.\r\n */\r\nfunction EventContext(requestSender, eventName, eventPayload) {\r\n  const eventData = eventPayload[eventName];\r\n  const contextPayload = createEventContextPayload(eventName, eventData);\r\n\r\n  const eventContextResult = new Proxy(eventData, {\r\n    get(target, prop) {\r\n      if (prop in target)\r\n        return target[prop];\r\n\r\n      if (prop === 'update')\r\n        return eventPayload;\r\n\r\n      if (prop === 'payload')\r\n        return contextPayload;\r\n\r\n      return (requestPayload = {}) => requestSender(prop, { ...contextPayload, ...requestPayload });\r\n    },\r\n  });\r\n\r\n  return eventContextResult;\r\n}\r\n\r\n/**\r\n * @callback requestSender - Synchronous function that accepts a method and payload.\r\n * @param {string} method - Telegram API method for the request.\r\n * @param {object} payload - The payload to send with the request.\r\n * @return {Object} - The response from the Telegram API.\r\n */","export default createHandlerStorage;\r\n\r\n/**\r\n * Creates a handler storage object.\r\n *\r\n * @return {Object} The handler storage object with the following methods:\r\n *   - has: a function that checks if a given type has any handlers\r\n *   - get: a function that retrieves the handlers for a given type\r\n *   - add: a function that adds a handler to the storage for a given type\r\n */\r\nfunction createHandlerStorage() {\r\n  const storage = new Map();\r\n\r\n  return {\r\n    has: type => storage.has(type),\r\n    get: type => storage.get(type),\r\n    add(type, value) {\r\n      if (storage.has(type))\r\n        storage.get(type).push(value);\r\n      else\r\n        storage.set(type, [value]);\r\n    }\r\n  };\r\n}","\r\nexport class EventContextError extends Error {\r\n  constructor(message) {\r\n    super(message);\r\n    this.name = 'EventContextError';\r\n  }\r\n}\r\nexport class BotContextError extends Error {\r\n  constructor(message) {\r\n    super(message);\r\n    this.name = 'BotContextErrors';\r\n  }\r\n}\r\n\r\n\r\nexport class PayloadValidationError extends Error {\r\n  constructor(message) {\r\n    super(message);\r\n    this.name = 'PayloadValidationError';\r\n  }\r\n}\r\n\r\n\r\nexport class ResponseError extends Error {\r\n  constructor(code, message) {\r\n    super(message);\r\n    this.code = code;\r\n    this.name = 'ResponseError';\r\n  }\r\n}","import EventContext from './EventContext.js';\r\nimport createHandlerStorage from '../utils/createHandlerStorage.js';\r\nimport { BotContextError } from './errors.js';\r\n\r\nexport default BotContext;\r\n\r\n/**\r\n * Creates a BotContext object that handles event handling and processing.\r\n *\r\n * @param {requestSender} requestSender - Function that accepts a method and payload.\r\n * @param {object} params - Optional parameters.\r\n * @param {string} params.match_separator - The separator used for event matching. Default is '::'.\r\n * @return {object} The BotContext object.\r\n */\r\nfunction BotContext(requestSender, params = {}) {\r\n  const EVENTS = createHandlerStorage();\r\n  const self = {};\r\n\r\n  /**\r\n   * Attaches an event handler for a specific event or event match.\r\n   *\r\n   * @param {string|function} eventName - The event or event match to attach the handler to.\r\n   * @param {function} eventHandler - The handler function to attach.\r\n   */\r\n  self.on = (eventName, eventHandler) => {\r\n    if (typeof eventName === 'function') {\r\n      eventHandler = eventName;\r\n      eventName = null;\r\n    }\r\n\r\n    const eventObject = { handler: eventHandler };\r\n    EVENTS.add(eventName, eventObject);\r\n\r\n    return {\r\n      catch(reject) {\r\n        eventObject.reject = reject;\r\n      }\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Processes the event payload by sequentially executing all relevant handlers.\r\n   * If a handler throws an error, it is caught and logged, and execution continues with the next handler.\r\n   *\r\n   * @param {object} eventPayload - The payload of the event.\r\n   * @returns {Promise<Array>} A promise that resolves with an array of results from successful handlers, flattened.\r\n   */\r\n  self.setUpdate = async (eventPayload) => {\r\n    const eventName = Object.keys(eventPayload).find(key => key !== 'update_id');\r\n    const eventContext = EventContext(requestSender, eventName, eventPayload);\r\n\r\n    const eventObjects = [];\r\n\r\n    if (EVENTS.has(eventName))\r\n      eventObjects.push(...EVENTS.get(eventName));\r\n\r\n    if (EVENTS.has(null))\r\n      eventObjects.push(...EVENTS.get(null));\r\n\r\n    const mapHandler = async ({ handler, reject }) => {\r\n      try {\r\n        return await handler(eventContext, eventName);\r\n      } catch (error) {\r\n        if (reject) \r\n          try {\r\n            return await reject(error, eventContext, eventName);\r\n          } catch (rejectError) {\r\n            console.error('An error occurred within the .catch() handler itself:', rejectError);\r\n            return error; // Return the original error\r\n          }\r\n  \r\n        else\r\n          return error;\r\n      }\r\n    };\r\n\r\n    if (params.parallel === true)\r\n      return Promise.all(eventObjects.map(mapHandler));\r\n\r\n    const results = [];\r\n    for (const eventObject of eventObjects) \r\n      results.push(await mapHandler(eventObject));\r\n    \r\n    return results;\r\n  };\r\n\r\n  const botContextResult = new Proxy(self, {\r\n    get: (target, prop) => target[prop]\r\n      ?? ((requestPayload = {}) => requestSender(prop, requestPayload)),\r\n\r\n    set(target, prop, value) {\r\n      if (prop in target)\r\n        throw new BotContextError(`Can't rewrite method \"${prop}\"`);\r\n\r\n      if (typeof value !== 'function')\r\n        throw new BotContextError(`New method \"${prop}\" must be a function`);\r\n\r\n      target[prop] = value(botContextResult);\r\n      return true;\r\n    },\r\n  });\r\n\r\n  return botContextResult;\r\n}\r\n\r\n/**\r\n * @callback requestSender - Synchronous function that accepts a method and payload.\r\n * @param {string} method - Telegram API method for the request.\r\n * @param {object} payload - The payload to send with the request.\r\n * @return {object} - The response from the Telegram API.\r\n */","import createRequestSender from '../utils/createNodeRequestSender.js';\r\nimport BotContext from './BotContext.js';\r\n\r\nexport default createNodeBot;\r\n\r\n\r\n/**\r\n * Creates a node bot with the given token and parameters.\r\n *\r\n * @param {string} token - The token used to authenticate the bot.\r\n * @param {object} params - Additional parameters for the bot (optional).\r\n * @return {BotContext} The created bot context.\r\n */\r\nfunction createNodeBot(token, {timeout=30000, apiUrl='https://api.telegram.org', ...params} = {}) {\r\n  const requestSender = createRequestSender(token, {timeout, apiUrl});\r\n  return BotContext(requestSender, params);\r\n}\r\n"],"names":["STRING_PROPS","prepareRequestPayload","requestPayloadEntries","result","key","value","createNodeRequestSender","token","timeout","apiUrl","method","payload","url","payloadEntries","request","isFile","item","buildMultipart","buildJSON","sendRequest","body","buffer","getSourceInfo","source","fs","boundary","eol","finalBoundary","parts","totalLength","filesToProcess","processedPayload","fileIndex","attachName","isObject","str","part","fieldName","file","filename","contentType","size","stream","headPart","headBuffer","eolBuffer","finalBoundaryBuffer","headers","resolve","reject","hostname","port","pathname","URL","req","https","res","chunks","chunk","resBody","data","pResolve","pReject","err","ContextDataEvents","event","businessHandler","createEventContextPayload","eventName","eventData","EventContext","requestSender","eventPayload","contextPayload","target","prop","requestPayload","createHandlerStorage","storage","type","BotContextError","message","BotContext","params","EVENTS","self","eventHandler","eventObject","eventContext","eventObjects","mapHandler","handler","error","rejectError","results","botContextResult","createNodeBot","createRequestSender"],"mappings":"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"}